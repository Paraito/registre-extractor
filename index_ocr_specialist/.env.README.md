# Environment Configuration

## ⚠️ Important: This Module Uses Root .env

The `index_ocr_specialist` module **does not use a local `.env` file**. Instead, it loads environment variables from the **root `.env` file** (one level up).

This ensures consistency across the entire project and avoids duplicate configuration.

---

## Configuration Location

```
registre-extractor/
├── .env                    ← Configuration is HERE (root level)
├── .env.example            ← Template with all variables
└── index_ocr_specialist/
    ├── .env.archive        ← Old .env file (archived for reference)
    └── config/runtime.ts   ← Loads from root .env
```

---

## Required Environment Variables

The following variables must be set in the **root `.env`** file:

### AI API Keys (Required)

```bash
# Gemini AI (for OCR extraction and line counting)
GEMINI_API_KEY=your-gemini-api-key-here

# Claude/Anthropic AI (for OCR boost and verification)
ANTHROPIC_API_KEY=your-anthropic-api-key-here
```

### Supabase Configuration (Required for process-queue command)

```bash
# Development
DEV_SUPABASE_URL=https://your-dev-project.supabase.co
DEV_SUPABASE_SERVICE_KEY=your-dev-service-role-key-here

# Staging (optional)
STAGING_SUPABASE_URL=https://your-staging-project.supabase.co
STAGING_SUPABASE_SERVICE_KEY=your-staging-service-role-key-here

# Production (optional)
PROD_SUPABASE_URL=https://your-prod-project.supabase.co
PROD_SUPABASE_SERVICE_KEY=your-prod-service-role-key-here
```

### Optional Configuration

```bash
# Qwen3-VL (optional alternative OCR model)
QWEN_API_URL=http://localhost:8000/v1
QWEN_MODEL_NAME=qwen3-vl
QWEN_API_KEY=
QWEN_PORT=3002

# Pipeline Configuration
MAX_LINES_PER_PAGE=60
EXTRACT_WINDOW=15
UPSCALE_FACTOR=2.0
VIEWPORT_SCALE=4.0

# Timeouts & Retries
REQUEST_TIMEOUT_MS=300000
MAX_RETRIES=3
DELAY_BETWEEN_REQUESTS=2000

# Directories
ARTIFACTS_DIR=./artifacts
LOGS_DIR=./logs
REPORTS_DIR=./reports
TEMP_DIR=./tmp

# Server Ports
PORT=3001
GEMINI_PORT=3001

# Test Configuration
TEST_PDF_URL=https://your-test-pdf-url.pdf
```

---

## How It Works

The `config/runtime.ts` file loads environment variables from the root directory:

```typescript
import { resolve } from 'path';
import dotenv from 'dotenv';

// Load from root directory (one level up)
const rootDir = resolve(__dirname, '../../');
dotenv.config({ path: resolve(rootDir, '.env.local') }); // Local overrides
dotenv.config({ path: resolve(rootDir, '.env') });       // Main config
```

---

## Setup Instructions

1. **Copy the root `.env.example` to `.env`**:
   ```bash
   cd /path/to/registre-extractor
   cp .env.example .env
   ```

2. **Edit the root `.env` file** and add your API keys:
   ```bash
   nano .env  # or use your preferred editor
   ```

3. **Set required variables**:
   - `GEMINI_API_KEY` (required)
   - `ANTHROPIC_API_KEY` (required)
   - `DEV_SUPABASE_URL` (required for process-queue)
   - `DEV_SUPABASE_SERVICE_KEY` (required for process-queue)

4. **Verify configuration**:
   ```bash
   cd index_ocr_specialist
   npm run analyze-throughput  # Should work without errors
   ```

---

## Migration from Local .env

The local `.env` file has been **archived** to `.env.archive` for reference.

If you need to restore any values:

1. **Check** `.env.archive` for your old configuration
2. **Copy** any needed values to the root `.env` file
3. **Verify** the configuration works

The `.env.archive` file is kept for reference only and is **not loaded** by the application.

---

## Troubleshooting

### "Missing required environment variables" Error

**Cause**: API keys not set in root `.env`

**Solution**: 
1. Check that `/path/to/registre-extractor/.env` exists
2. Verify `GEMINI_API_KEY` and `ANTHROPIC_API_KEY` are set
3. Ensure no typos in variable names

### "Invalid environment" Error (process-queue)

**Cause**: Supabase credentials not set for the specified environment

**Solution**:
1. For `--env dev`: Set `DEV_SUPABASE_URL` and `DEV_SUPABASE_SERVICE_KEY`
2. For `--env staging`: Set `STAGING_SUPABASE_URL` and `STAGING_SUPABASE_SERVICE_KEY`
3. For `--env prod`: Set `PROD_SUPABASE_URL` and `PROD_SUPABASE_SERVICE_KEY`

### Configuration Not Loading

**Cause**: Running from wrong directory or incorrect path resolution

**Solution**:
1. Always run commands from `index_ocr_specialist/` directory
2. Verify the root `.env` file exists at `../env`
3. Check file permissions (should be readable)

---

## References

- **Root .env.example**: `../.env.example` (template with all variables)
- **Runtime Config**: `config/runtime.ts` (loads environment variables)
- **Process Queue**: `src/server/process-queue.ts` (uses Supabase env vars)
- **Documentation**: `docs/QUICK_REFERENCE.md`

